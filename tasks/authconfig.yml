---
# Authconfig tasks

- block:
    - name: Check if configuration files are autogenerated by authconfig
      stat:
        path: "/etc/pam.d/{{ login_defs_pam_auth_file }}"
      register: login_defs_stat_pam_auth_result
      loop:
        - password-auth
        - system-auth
      loop_control:
        loop_var: login_defs_pam_auth_file

    - name: Remove soft link to authconfig generated files
      file:
        path: >-
         {{ "/etc/pam.d/"
            + login_defs_stat_pam_auth_result_item.login_defs_pam_auth_file }}
        state: absent
      when:
        - login_defs_stat_pam_auth_result_item.stat.islnk is defined
        - login_defs_stat_pam_auth_result_item.stat.islnk
      loop: "{{ login_defs_stat_pam_auth_result.results }}"
      loop_control:
        loop_var: login_defs_stat_pam_auth_result_item
        label: >-
           {{ "/etc/pam.d/"
              + login_defs_stat_pam_auth_result_item.login_defs_pam_auth_file }}

    - include_tasks: authconfig_el.yml
      when:
        - login_defs_stat_pam_auth_result_item.stat.islnk is defined
        - login_defs_stat_pam_auth_result_item.stat.islnk
        - ansible_facts.distribution | lower in ["centos". "redhat"]

    - include_tasks: authconfig_fedora.yml
      when:
        - login_defs_stat_pam_auth_result_item.stat.islnk is defined
        - login_defs_stat_pam_auth_result_item.stat.islnk
        - ansible_facts.distribution | lower in ["fedora"]
  tags:
    - role::login_defs::authconfig
