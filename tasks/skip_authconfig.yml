- block:

    - name: check if configuration files are autogenerated by authconfig
      stat:
        path: "/etc/pam.d/{{ login_defs_pam_auth_file }}"
      register: login_defs_pam_auth_result
      loop:
        - password-auth
        - system-auth
      loop_control:
        loop_var: login_defs_pam_auth_file

    - debug: var=login_defs_pam_auth_result

    - name: remove soft link to authconfig generated files
      file:
        path: "/etc/pam.d/{{ login_defs_pam_auth_result_item.login_defs_pam_auth_file }}"
        state: absent
      when:
        - login_defs_pam_auth_result_item.stat.islnk is defined
        - login_defs_pam_auth_result_item.stat.islnk
      loop: "{{ login_defs_pam_auth_result.results }}"
      loop_control:
        loop_var: login_defs_pam_auth_result_item


    - name: copy default files in rhel or centos
      copy:
        src: "/etc/pam.d/{{ login_defs_pam_auth_result_item.login_defs_pam_auth_file }}-ac"
        dest: "/etc/pam.d/{{ login_defs_pam_auth_result_item.login_defs_pam_auth_file }}"
        remote_src: yes
      when:
        - login_defs_pam_auth_result_item.stat.islnk is defined
        - login_defs_pam_auth_result_item.stat.islnk
        - ansible_facts.distribution | lower in ["redhat", "centos"]
      loop: "{{ login_defs_pam_auth_result.results }}"
      loop_control:
        loop_var: login_defs_pam_auth_result_item

    - name: copy default files in fedora
      copy:
        src: "/etc/authselect/{{ login_defs_pam_auth_result_item.login_defs_pam_auth_file }}"
        dest: "/etc/pam.d/{{ login_defs_pam_auth_result_item.login_defs_pam_auth_file }}"
        remote_src: yes
      when:
        - login_defs_pam_auth_result_item.stat.islnk is defined
        - login_defs_pam_auth_result_item.stat.islnk
        - ansible_facts.distribution | lower in ["fedora"]
      loop: "{{ login_defs_pam_auth_result.results }}"
      loop_control:
        loop_var: login_defs_pam_auth_result_item

  tags:
    - role::login_defs::authconfig
