---
# Faillock config tasks

- block:
    - name: Search if pam_faillock is configured in system-auth config file
      shell: "cat {{ login_defs_system_auth_config_file }}"
      changed_when: false
      register: search_system_auth_config

    - name: Search if pam_faillock is configured in password-auth config file
      shell: "cat {{ login_defs_password_auth_config_file }}"
      changed_when: false
      register: search_password_auth_config

    - name: Include faillock auth configuration
      replace:
        path: "{{ login_defs_faillock_item }}"
        regexp: "^auth(.*)pam_unix.so(.*)$"
        replace: "{{ login_defs_pam_faillock_pam_d_config }}"
      when:
        - search_password_auth_config.stdout is not search("pam_faillock.so")
        - search_system_auth_config.stdout is not search("pam_faillock.so")
      loop:
        - "{{ login_defs_system_auth_config_file }}"
        - "{{ login_defs_password_auth_config_file }}"
      loop_control:
        loop_var:   login_defs_faillock_item
  tags:
    - role::login_defs::faillock
