---
# Faillock config tasks

- block:
    - name: Search if pam_faillock is configured in system-auth config file
      shell: "cat {{ login_defs_system_auth_config_file }}"
      changed_when: false
      register: search_system_auth_config

    - name: Search if pam_faillock is configured in password-auth config file
      shell: "cat {{ login_defs_password_auth_config_file }}"
      changed_when: false
      register: search_password_auth_config

    - block:

        - name: Include faillock auth configuration
          command: >-
                    /usr/sbin/authconfig
                    --enablefaillock
                    --faillockargs='deny={{ login_defs_pam_faillock_deny }} unlock_time={{ login_defs_pam_faillock_unlock_time }}'
                    --updateall

        - name: Fix bug 1485490 acording https://access.redhat.com/solutions/4175751  (1)
          lineinfile:
            path: "{{ login_defs_password_auth_config_file }}"
            regexp: "^auth( +)required( +)pam_faillock.so( +)authfail"
            state: absent

        - name: Fix bug 1485490 acording https://access.redhat.com/solutions/4175751  (2)
          lineinfile:
            path: "{{ login_defs_password_auth_config_file }}"
            insertbefore: "^auth( +)required( +)pam_deny.so"
            line: "{{ login_defs_pam_faillock_pam_d_config_bugfix }}"

      when:
        - search_password_auth_config.stdout is not search("pam_faillock.so")
        - search_system_auth_config.stdout is not search("pam_faillock.so")
        - login_defs_pam_faillock_state == "present"
        - ansible_facts.distribution | lower in ["centos", "rehat"]
        - ansible_facts.distribution_major_version is version('7', '==')

    - block:

        - name: Exclude faillock auth configuration
          command: >-
                    /usr/sbin/authconfig
                    --disablefaillock
                    --updateall

      when:
        - search_password_auth_config.stdout is search("pam_faillock.so")
        - search_system_auth_config.stdout is search("pam_faillock.so")
        - login_defs_pam_faillock_state == "absent"
        - ansible_facts.distribution | lower in ["centos", "rehat"]
        - ansible_facts.distribution_major_version is version('7', '==')
  tags:
    - role::login_defs::faillock
